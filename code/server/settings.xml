<?xml version="1.0" encoding="UTF-8"?>

<!-- -->
<settings>
	<database name="stats">
		<tables>
			<table>events</table> 
			<events>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>date</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>organization</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>location</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>attendance</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>completed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>child_url</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>event_updated</name>
					<dbtype>integer</dbtype>
				</column>			
			</events>

			<table>tmp_events</table>
			<tmp_events>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>completed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>child_url</name>
					<dbtype>text</dbtype>
				</column>
			</tmp_events>

			<table>fights</table>
			<fights>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>event_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fighter_a_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fighter_b_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fighter_a_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>fighter_b_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>weight_class</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>finish_method</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>finish_details</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>rounds_fought</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>time_in_last_round</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>round_format</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>referee_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>child_url</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>fight_updated</name>
					<dbtype>integer</dbtype>
				</column>
			</fights>

			<table>rounds</table>
			<rounds>
				<primary-key><![CDATA[fight_id]]></primary-key>
				<primary-key><![CDATA[fighter_id]]></primary-key>
				<primary-key><![CDATA[round]]></primary-key>
				<column>
					<name>fight_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>round</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fighter_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fighter_name</name>
					<dbtype>string</dbtype>
				</column>
				<column>
					<name>knockdowns</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>sig_strikes</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>sig_strikes_landed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>strikes</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>strikes_landed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>takedown_attempts</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>takedowns_completed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>submission_attempts</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>guard_passes</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>reversals</name>
					<dbtype>integer</dbtype>
				</column>
			</rounds>

			<table>scorecards</table> 
			<scorecards>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fight_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>judge</name>
					<dbtype>string</dbtype>
				</column>
				<column>
					<name>fighter_a_score</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>fighter_b_score</name>
					<dbtype>integer</dbtype>
				</column>
			</scorecards>

			<table>fighters</table> 
			<fighters>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
			</fighters>

			<table>tmp_fighters</table> 
			<tmp_fighters>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
			</tmp_fighters>
		</tables>
	</database>

	<!-- scraper tasks settings -->

	<scrape-tasks>
		<completed-events>
			<data-source>
				<const-source>true</const-source> <!-- const-url -->
				<const-path><![CDATA[/events/index/date/desc/1/all]]></const-path>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<source-size-statement><![CDATA[]]></source-size-statement>
				<source-statement><![CDATA[]]></source-statement>
			</data-source>
			<scrapers>
				<completed-events>
					<f-key>0</f-key>
					<statement><![CDATA[INSERT OR REPLACE INTO tmp_events (id, completed, child_url) VALUES (?, 1, ?)]]></statement>
				</completed-events>
			</scrapers>
		</completed-events>

		<upcoming-events>
			<data-source>
				<const-source>true</const-source> <!-- const-url -->
				<const-path><![CDATA[/events/index/date/asc/0/all]]></const-path>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<source-size-statement><![CDATA[]]></source-size-statement>
				<source-statement><![CDATA[]]></source-statement>
			</data-source>
			<scrapers>
				<upcoming-events>
					<f-key><![CDATA[0]]></f-key>
					<statement><![CDATA[INSERT OR REPLACE INTO tmp_events (id, completed, child_url) VALUES (?, 0, ?)]]></statement>
				</upcoming-events>
			</scrapers>
		</upcoming-events>

		<event-details-fights>
			<data-source>
				<const-source>false</const-source> <!-- const-url -->
				<const-path></const-path>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<source-size-statement><![CDATA[SELECT COUNT(*) FROM events WHERE event_updated = 0]]></source-size-statement>
				<source-statement><![CDATA[select child_url, id FROM events WHERE event_updated = 0]]></source-statement>
			</data-source>
			<scrapers>
				<event-details>
					<f-key><![CDATA[1]]></f-key>
					<statement><![CDATA[UPDATE events SET name=?, date=?, organization=?, location=?, attendance=?, event_updated=1 WHERE id=?]]></statement>
				</event-details>
				<fights>
					<f-key>1</f-key>
					<statement><![CDATA[INSERT OR REPLACE INTO fights (id, fighter_a_id, fighter_b_id, fighter_a_name, fighter_b_name, weight_class, finish_method, finish_details, rounds_fought, time_in_last_round, round_format, referee_name, child_url, fight_updated, event_id) VALUES (?, '', '', '', '', '', '', '', '', '', '', '', ?, 0, ?)]]></statement>
				</fights>
			</scrapers>
		</event-details-fights>

		<fight-details-rounds>
			<data-source>
				<const-source>false</const-source> <!-- db_url -->
				<const-path></const-path>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<source-size-statement><![CDATA[SELECT COUNT(*) FROM fights WHERE fight_updated = 0]]></source-size-statement>
				<source-statement><![CDATA[SELECT child_url, id, fighter_a_id FROM fights WHERE fight_updated = 0]]></source-statement>
			</data-source>
			<scrapers>
				<fight-details>
					<f-key>1</f-key><!-- 1 up to 15  -->
					<statement><![CDATA[UPDATE fights SET fighter_a_id=?, fighter_b_id=?, fighter_a_name=?, fighter_b_name=?, weight_class=?, finish_method=?, finish_details=?, rounds_fought=?, time_in_last_round=?, round_format=?, referee_name=? WHERE id=?]]></statement>
				</fight-details>
				<rounds>
					<f-key>2</f-key><!-- 0 up to 31, can have multiple fields -->
					<f-key>1</f-key><!-- 0 up to 31, can have multiple fields -->
					<statement><![CDATA[INSERT OR REPLACE INTO rounds (fighter_name, round, knockdowns, sig_strikes, sig_strikes_landed, strikes, strikes_landed, takedown_attempts, takedowns_completed, submission_attempts, guard_passes, reversals, fighter_id, fight_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]]></statement>
				</rounds>
			</scrapers>
		</fight-details-rounds>
	</scrape-tasks>

	<data-tasks>
		<compare-events>			
			<prepared-statement><![CDATA[INSERT OR REPLACE INTO events 
				SELECT tmp_events.id AS id, '' AS name, '' AS date, '' AS organization, '' AS location, '' AS attendance, tmp_events.completed AS completed, tmp_events.child_url AS child_url, 0 AS event_updated
				FROM tmp_events
				LEFT JOIN events
				  ON (tmp_events.id = events.id AND tmp_events.completed = events.completed)
				  WHERE events.id IS NULL]]>
			</prepared-statement>
			<prepared-statement><![CDATA[DELETE FROM tmp_events]]></prepared-statement>
		</compare-events>
	</data-tasks>

	<!-- scraper settings -->

	<scrapers>
		<completed-events>
			<pre-process>
				<extract><![CDATA[(<div[\s]class="events_table[\s]data_table[\s]row_is_link">[\w\W]*?<tr[\s]>)([\w\W]*?)(</div>)]]></extract>
				<index-delimiter><![CDATA[</tr>[\w\W]*?<tr.+?>]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>id</name>
				<apptype>integer</apptype>
				<regex><![CDATA[(.events.details.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(href=")(.*)(">)]]></regex>
			</scrape-field>
		</completed-events>

		<upcoming-events>
			<pre-process>
				<extract><![CDATA[(<div[\s]class="events_table[\s]data_table[\s]row_is_link">[\w\W]*?<tr[\s]>)([\w\W]*?)(</div>)]]></extract>
				<index-delimiter><![CDATA[</tr>[\w\W]*?<tr.+?>]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>id</name>
				<apptype>integer</apptype>
				<regex><![CDATA[(.events.details.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<td[\s]class="left_border"><a href=")(.*)(">)]]></regex>
			</scrape-field>
		</upcoming-events>

		<event-details>
			<pre-process>
				<extract><![CDATA[(<div[\s]class="header">)(.*?)(</div>)]]></extract>
				<index-delimiter><![CDATA[]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<h1\s+class="event_header_h1">)(.*)(</h1>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>date</name> 
				<apptype>date</apptype>
				<regex><![CDATA[(<td[\s]+class="title_text">DATE</td>[\w\W]*?<td>)(.*?)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>organization</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(ORGANIZATION.+?<td>)([\w\s]+?)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>location</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(LOCATION.+?<td>)([^<]+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>attendance</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td\s+class="title_text">ATTENDANCE</td>[\w\W]+?<td>)([0-9,]*)(</td>)]]></regex>
			</scrape-field>
		</event-details>

		<fights>
			<pre-process>
				<extract><![CDATA[(<td[\s]rowspan="2"[\s]class="rowspan">)([\w\W]*?)(</table>)]]></extract>
				<index-delimiter><![CDATA[<td[\s]rowspan="2"[\s]class="rowspan">]]></index-delimiter>
			</pre-process>
			
			<scrape-field>
				<name>id</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(.fights.index.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<a[\s]href=")(.fights.index.\d+)("[\s]class="arrow"></a>)]]></regex>
			</scrape-field>
		</fights>

		<fight-details>
			<pre-process>
				<extract><![CDATA[(class="fight_details_h1")(.*?)(</table>)]]></extract>
				<index-delimiter><![CDATA[\A]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>fighter_a_id</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(fighters[/]details[/].*?){1}([^"]+)(")]]></regex>
			</scrape-field>
			<scrape-field>
				<name>fighter_b_id</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(fighters[/]details[/].*?){2}([^"]+)(")]]></regex>
			</scrape-field>
			<scrape-field>
				<name>fighter_a_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(fighters[/]details[/]\d+">.*?){1}([^<]+)(<)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>fighter_b_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(fighters[/]details[/]\d+">.*?){2}([^<]+)(<)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>weight_class</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(?i)()((OPEN|CATCH|FLY|BANTAM|FEATHER|LIGHT[\s]?|WELTER|MIDDLE|HEAVY|WEIGHT)+)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>finish_method</name> 
				<apptype>string</apptype>
				<regex><![CDATA[fight_details_info(.)*?(?=<td>)<td>([^<]+)()]]></regex>
			</scrape-field>
			<scrape-field>
				<name>finish_details</name> 
				<apptype>html</apptype>
				<regex><![CDATA[DETAILS.*?(<td\scolspan[^>]*>\s+)(.*?)\s+(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>rounds_fought</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(fight_details_info.*?nbsp.)(\d)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>time_in_last_round</name> 
				<apptype>time</apptype>
				<regex><![CDATA[(fight_details_info.*?\s)(\d:\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>round_format</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(?i)()fight_details_info.*?(No Time Limit|([-()1-5]){3,})</td>]]></regex>
			</scrape-field>
			<scrape-field>
				<name>referee_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[()referees[/]details[/]([^"]+)()]]></regex>
			</scrape-field>
		</fight-details>

		<rounds>
			<pre-process>
				<extract><![CDATA[(class="fight_round")(.*?)(</table>)]]></extract>
				<index-delimiter><![CDATA[class="fight_round"]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>fighter_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<td>)([^<]+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>round</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(ROUND[\s]+)([^<])()]]></regex>
			</scrape-field>
			<scrape-field>
				<name>knockdowns</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){1}([^<]+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>sig_strikes</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){2}(\d+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>sig_strikes_landed</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){2}(\d+)([\s]of)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>strikes</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){4}(\d+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>strikes_landed</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){4}(\d+)([\s]of)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>takedown_attempts</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){5}(\d+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>takedowns_completed</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){5}(\d+)([\s]of)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>submission_attempts</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){7}([^<]+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>guard_passes</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){9}([^<]+)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>reversals</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">.*?){9}([^<]+)(</td>)]]></regex>
			</scrape-field>
		</rounds>
	</scrapers>
</settings> 