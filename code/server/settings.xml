<?xml version="1.0" encoding="UTF-8"?>

<!-- -->
<settings>
	<database name="stats">
		<tables>
			<table>events</table> 
			<events>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>date</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>organization</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>location</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>attendance</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>completed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>child_url</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>event_updated</name>
					<dbtype>integer</dbtype>
				</column>			
			</events>

			<table>tmp_events</table>
			<tmp_events>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>completed</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>child_url</name>
					<dbtype>text</dbtype>
				</column>
			</tmp_events>

			<table>fights</table>
			<fights>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>event_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>defender_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>contender_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>winner_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>loser_id</name>
					<dbtype>integer</dbtype>
				</column>
				<column>
					<name>winner_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>loser_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>weight_class</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>finish_method</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>finish_details</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>rounds_fought</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>time_in_last_round</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>round_format</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>referee_name</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>child_url</name>
					<dbtype>text</dbtype>
				</column>
				<column>
					<name>fight_updated</name>
					<dbtype>integer</dbtype>
				</column>
			</fights>

			<table>rounds</table>
			<rounds>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>event_id</name>
					<dbtype>integer</dbtype>
				</column>
			</rounds>

			<table>fighters</table> 
			<fighters>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>event_id</name>
					<dbtype>integer</dbtype>
				</column>
			</fighters>

			<table>tmp_fighters</table> 
			<fighters>
				<primary-key><![CDATA[id]]></primary-key>
				<column>
					<name>event_id</name>
					<dbtype>integer</dbtype>
				</column>
			</fighters>
		</tables>
	</database>

	<!-- scraper tasks settings -->

	<scrape-tasks>
		<completed-events>
			<data-source>
				<source-type>file</source-type> <!-- const-url -->
				<url-constant><![CDATA[http://hosteddb.fightmetric.com/events/index/date/desc/1/all]]></url-constant>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<file-uri><![CDATA[E:\projekt\MMAFL\code\server\www\fm_c_events.htm]]></file-uri>
				<source-size-statement><![CDATA[]]></source-size-statement>
				<source-statement><![CDATA[]]></source-statement>
				<f-key-index>0</f-key-index>
			</data-source>
			<scrapers>
				<completed-events>
						<f-key>false</f-key>
						<f-key-insert>0</f-key-insert>
						<statement><![CDATA[INSERT OR REPLACE INTO tmp_events (id, completed, child_url) VALUES (?, 1, ?)]]></statement>
				</completed-events>
			</scrapers>
		</completed-events>

		<upcoming-events>
			<data-source>
				<source-type>file</source-type> <!-- const-url -->
				<url-constant><![CDATA[http://hosteddb.fightmetric.com/events/index/date/asc/0/all/]]></url-constant>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<file-uri><![CDATA[E:\projekt\MMAFL\code\server\www\fm_u_events.htm]]></file-uri>
				<source-size-statement><![CDATA[]]></source-size-statement>
				<source-statement><![CDATA[]]></source-statement>
				<f-key-index>0</f-key-index>
			</data-source>
			<scrapers>
				<upcoming-events>
						<f-key>false</f-key>
						<f-key-insert>0</f-key-insert>
						<statement><![CDATA[INSERT OR REPLACE INTO tmp_events (id, completed, child_url) VALUES (?, 0, ?)]]></statement>
				</upcoming-events>
			</scrapers>
		</upcoming-events>

		<event-details-fights>
			<data-source>
				<source-type>db_debug</source-type> <!-- db_url -->
				<url-constant></url-constant>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<file-uri><![CDATA[E:\projekt\MMAFL\code\server\www\fm_event.htm]]></file-uri>
				<source-size-statement><![CDATA[SELECT COUNT(*) FROM events WHERE event_updated = 0]]></source-size-statement>
				<source-statement><![CDATA[select id, child_url FROM events WHERE event_updated = 0]]></source-statement>
				<f-key-index>0</f-key-index>
			</data-source>
			<scrapers>
				<event-details>
						<f-key>true</f-key>
						<f-key-insert>1</f-key-insert>
						<statement><![CDATA[UPDATE events SET name=?, date=?, organization=?, location=?, attendance=?, event_updated=1 WHERE id=?]]></statement>
				</event-details>
				<fights>
						<f-key>true</f-key>
						<f-key-insert>-1</f-key-insert>
						<statement><![CDATA[INSERT OR REPLACE INTO fights (event_id, id, defender_name, contender_name, winner_id, loser_id, winner_name, loser_name, weight_class, finish_method, finish_details, rounds_fought, time_in_last_round, round_format, referee_name, child_url, fight_updated) VALUES (?, ?, '', '', '', '', '', '', '', '', '', '', '', '', '', ?, 0)]]></statement>
				</fights>
			</scrapers>
		</event-details-fights>

		<fight-details-rounds>
			<data-source>
				<source-type>db_debug</source-type> <!-- db_url -->
				<url-constant></url-constant>
				<url-domain><![CDATA[http://hosteddb.fightmetric.com]]></url-domain>
				<file-uri><![CDATA[E:\projekt\MMAFL\code\server\www\fm_fight.htm]]></file-uri>
				<source-size-statement><![CDATA[SELECT COUNT(*) FROM fights WHERE fight_updated = 0]]></source-size-statement>
				<source-statement><![CDATA[select id, child_url FROM fights WHERE fight_updated = 0]]></source-statement>
				<f-key-index>0</f-key-index>
			</data-source>
			<scrapers>
				<fight-details>
						<f-key>true</f-key>
						<f-key-insert>1</f-key-insert>
						<statement><![CDATA[UPDATE fights SET defender_name=?, contender_name=?, winner_id=?, loser_id=?, winner_name=?, loser_name=?, weight_class=?, finish_method=?, finish_details=?, rounds_fought=?, time_in_last_round=?, round_format=?, referee_name=?, fight_updated=1 WHERE id=?]]></statement>
				</fight-details>
				<rounds>
						<f-key>true</f-key>
						<f-key-insert>-1</f-key-insert>
						<statement><![CDATA[]]></statement>
				</rounds>
			</scrapers>
		</fight-details-rounds>
	</scrape-tasks>

	<data-tasks>
		<compare-events>			
			<prepared-statement><![CDATA[INSERT OR REPLACE INTO events 
				SELECT tmp_events.id AS id, '' AS name, '' AS date, '' AS organization, '' AS location, '' AS attendance, tmp_events.completed AS completed, tmp_events.child_url AS child_url, 0 AS event_updated
				FROM tmp_events
				LEFT JOIN events
				  ON (tmp_events.id = events.id AND tmp_events.completed = events.completed)
				  WHERE events.id IS NULL]]>
			</prepared-statement>
			<prepared-statement><![CDATA[DELETE FROM tmp_events]]></prepared-statement>
		</compare-events>
	</data-tasks>

	<!-- scraper settings -->

	<scrapers>
		<completed-events>
			<pre-process>
				<extract><![CDATA[(<div[\s]class="events_table[\s]data_table[\s]row_is_link">[\w\W]*?<tr[\s]>)([\w\W]*?)(</div>)]]></extract>
				<index-delimiter><![CDATA[</tr>[\w\W]*?<tr.+?>]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>id</name>
				<apptype>integer</apptype>
				<regex><![CDATA[(.events.details.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(href=")(.*)(">)]]></regex>
			</scrape-field>
		</completed-events>

		<upcoming-events>
			<pre-process>
				<extract><![CDATA[(<div[\s]class="events_table[\s]data_table[\s]row_is_link">[\w\W]*?<tr[\s]>)([\w\W]*?)(</div>)]]></extract>
				<index-delimiter><![CDATA[</tr>[\w\W]*?<tr.+?>]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>id</name>
				<apptype>integer</apptype>
				<regex><![CDATA[(.events.details.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<td[\s]class="left_border"><a href=")(.*)(">)]]></regex>
			</scrape-field>
		</upcoming-events>

		<event-details>
			<pre-process>
				<extract><![CDATA[(<div[\s]class="header">)([\w\W]*?)(</div>)]]></extract>
				<index-delimiter><![CDATA[]]></index-delimiter>
			</pre-process>

			<scrape-field>
				<name>name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<h1\s+class="event_header_h1">)(.*)(</h1>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>date</name> 
				<apptype>date</apptype>
				<regex><![CDATA[(<td[\s]+class="title_text">DATE</td>[\w\W]*?<td>)(.*?)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>organization</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<td[\s]class="title_text">ORGANIZATION</td>[\w\W]+?<td>)(.*)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>location</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<td\s+class="title_text">LOCATION</td>[\w\W]+?<td>)(.*)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>attendance</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td\s+class="title_text">ATTENDANCE</td>[\w\W]+?<td>)(.*)(</td>)]]></regex>
			</scrape-field>
		</event-details>

		<fights>
			<pre-process>
				<extract><![CDATA[(<td[\s]rowspan="2"[\s]class="rowspan">)([\w\W]*?)(</table>)]]></extract>
				<index-delimiter><![CDATA[<td[\s]rowspan="2"[\s]class="rowspan">]]></index-delimiter>
			</pre-process>
			
			<scrape-field>
				<name>id</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(.fights.index.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<a[\s]href=")(.fights.index.\d+)("[\s]class="arrow"></a>)]]></regex>
			</scrape-field>
		</fights>

		<fight-details>
			<pre-process>
				<extract><![CDATA[]]></extract>
				<index-delimiter><![CDATA[]]></index-delimiter>
			</pre-process>
			
			<scrape-field>
				<name>defender_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(class="arrow">[\w\W]+?fighters.details.\d+">)(\D+)(</a>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>contender_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(</tr>[\w\W]+fighters.details.\d+">)(\D+)(</a>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>winner_id</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(Win[\w\W]+?fighters.details.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>loser_id</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(Win[\w\W]+?</tr>[\w\W]+?fighters.details.)(\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>winner_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(Win[\w\W]+?fighters.details.\d+">)(\D+?)(</a>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>loser_name</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(Win[\w\W]+?</tr>[\w\W]+?fighters.details.\d+">)(\D+?)(</a>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>weight_class</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(<td>)(\w+weight)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>finish_method</name> 
				<apptype>string</apptype>
				<regex><![CDATA[(\w+weight[\w\W]+<td>)(.*?)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>finish_details</name> 
				<apptype>string</apptype>
				<regex><![CDATA[]]></regex>
			</scrape-field>
			<scrape-field>
				<name>rounds_fought</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">)(\d)(</td>)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>time_in_last_round</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td[\s]align="center">\d</td>[\w\W]+?<td>[\w\W]+?)(\d:\d+)(\D)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>round_format</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\d+.*\s+.*\s+.*\s+\D+)(.*)(</td>*?)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>referee_name</name> 
				<apptype>integer</apptype>
				<regex><![CDATA[(<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\d+.*\s+.*\s+.*\s+\D+)(.*)(</td>*?)]]></regex>
			</scrape-field>
			<scrape-field>
				<name>child_url</name>
				<apptype>string</apptype>
				<regex></regex>
			</scrape-field>
			<scrape-field>
				<name>fight_updated</name>
				<apptype>string</apptype>
				<regex></regex>
			</scrape-field>
		</fight-details>
	</scrapers>
</settings> 